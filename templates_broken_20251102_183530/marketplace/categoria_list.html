{% extends "base.html" %}
{% load static %}

{% block title %}{{ meta_title }}{% endblock %}

{% block content %}
<style>
  .wrap{ max-width:1100px; margin:16px auto; padding:0 16px; }
  .filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:12px 0; }
  .pill{ border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; background:#fff; font-size:.92rem; text-decoration:none; color:#111827; }
  .pill.active{ background:#111827; color:#fff; border-color:#111827; }
  .select{ border:1px solid #e5e7eb; border-radius:8px; padding:6px 8px; font-size:.92rem; }
  .grid{ display:grid; gap:12px; grid-template-columns: repeat(2,1fr); }
  @media (min-width: 768px){ .grid{ grid-template-columns: repeat(3,1fr);} }
  @media (min-width: 1100px){ .grid{ grid-template-columns: repeat(4,1fr);} }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; }
  .thumb{ aspect-ratio:4/3; object-fit:cover; width:100%; display:block; background:#f3f4f6; }
  .card-body{ padding:10px 12px; }
  .title{ font-weight:700; margin:0 0 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta{ color:#6b7280; font-size:.92rem; display:flex; justify-content:space-between; gap:8px; }
  .price{ color:#111827; font-weight:800; }
  .price s{ color:#9ca3af; font-weight:500; margin-left:6px; }
  .badge{ font-size:.85rem; border-radius:999px; padding:4px 8px; border:1px solid #e5e7eb; }
  .b-warn{ background:#fffbeb; border-color:#fde68a; }
  .b-err{ background:#fef2f2; border-color:#fecaca; }
  .pagination{ display:flex; gap:6px; justify-content:center; margin-top:12px; }
  .page-link{ border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; text-decoration:none; color:#111827; }
  .page-link.active{ background:#111827; color:#fff; border-color:#111827; }
</style>

<div class="wrap">
  <div class="crumbs" style="color:#6b7280;margin-bottom:8px;">
    <a href="/" style="color:#2563eb;text-decoration:none;">Inicio</a> Ã¢â‚¬Âº <span>{{ titulo }}</span>
  </div>

  <h1 style="margin:0 0 6px;">{{ titulo }}</h1>
  <p class="muted" style="color:#6b7280;margin-bottom:8px;">Packs disponibles en {{ titulo }}.</p>

  <div class="filters">
    <a class="pill {% if f_oferta %}active{% endif %}"
       href="?oferta={% if f_oferta %}0{% else %}1{% endif %}&stock={{ f_stock|yesno:'1,0' }}&abierto={{ f_abierto|yesno:'1,0' }}&orden={{ orden }}">Ofertas</a>

    <a class="pill {% if f_stock %}active{% endif %}"
       href="?oferta={{ f_oferta|yesno:'1,0' }}&stock={% if f_stock %}0{% else %}1{% endif %}&abierto={{ f_abierto|yesno:'1,0' }}&orden={{ orden }}">Con stock</a>

    <a class="pill {% if f_abierto %}active{% endif %}"
       href="?oferta={{ f_oferta|yesno:'1,0' }}&stock={{ f_stock|yesno:'1,0' }}&abierto={% if f_abierto %}0{% else %}1{% endif %}&orden={{ orden }}">Abierto ahora</a>

    <span class="muted" style="margin-left:auto;color:#6b7280;">Orden:</span>
    <select id="ordenSel" class="select">
      <option value="nuevo" {% if orden == 'nuevo' %}selected{% endif %}>MÃƒÂ¡s nuevo</option>
      <option value="mas-comprado" {% if orden == 'mas-comprado' %}selected{% endif %}>MÃƒÂ¡s comprado</option>
      <option value="precio-asc" {% if orden == 'precio-asc' %}selected{% endif %}>Precio Ã¢â€ â€˜</option>
      <option value="precio-desc" {% if orden == 'precio-desc' %}selected{% endif %}>Precio Ã¢â€ â€œ</option>
    </select>
  </div>

  <div class="grid">
    {% for p in page.object_list %}
      <a class="card link" href="/packs/{{ p.id }}/">
        {% if p.imagen %}
          <img class="thumb" src="{{ p.image_or_stock_url }}" alt="{{ p.titulo|default:'Pack' }}" loading="lazy" decoding="async">
        {% else %}
          <img class="thumb" src="{% static 'img/placeholder-pack.svg' %}" alt="" aria-hidden="true" loading="lazy" decoding="async">
        {% endif %}
        <div class="card-body">
          <p class="title">{{ p.titulo|default:"Pack" }}</p>
          <div class="meta">
            <span class="price">
              ${{ p.precio_oferta|default:p.precio_original }}
              {% if p.precio_oferta and p.precio_oferta < p.precio_original %}
                <s>${{ p.precio_original }}</s>
              {% endif %}
            </span>
            <span>{{ p.partner.nombre }}</span>
          </div>
          <div class="meta" style="margin-top:6px;">
            {% if p.stock <= 0 %}
              <span class="badge b-err">Sin stock</span>
            {% elif p.stock < 5 %}
              <span class="badge b-warn">Ã‚Â¡Quedan {{ p.stock }}!</span>
            {% else %}
              <span class="badge">Stock: {{ p.stock }}</span>
            {% endif %}
            <span class="muted">Retiro {{ p.pickup_start|date:"d/m H:i" }}Ã¢â‚¬â€œ{{ p.pickup_end|date:"H:i" }}</span>
          </div>
        </div>
      </a>
    {% empty %}\n  <div style="grid-column:1/-1;">\n    {% include "partials/empty.html" with title="Sin publicaciones en esta categorÃ­a" subtitle="ProbÃ¡ otra categorÃ­a o volvÃ© mÃ¡s tarde." cta_href="/packs/" cta_label="Ver todos los packs" %}\n  </div>\n{% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
    <div class="pagination">
      {% if page.has_previous %}
        <a class="page-link" href="?page={{ page.previous_page_number }}&oferta={{ f_oferta|yesno:'1,0' }}&stock={{ f_stock|yesno:'1,0' }}&abierto={{ f_abierto|yesno:'1,0' }}&orden={{ orden }}">Ã‚Â«</a>
      {% endif %}
      {% for i in page.paginator.page_range %}
        <a class="page-link {% if i == page.number %}active{% endif %}"
           href="?page={{ i }}&oferta={{ f_oferta|yesno:'1,0' }}&stock={{ f_stock|yesno:'1,0' }}&abierto={{ f_abierto|yesno:'1,0' }}&orden={{ orden }}">{{ i }}</a>
      {% endfor %}
      {% if page.has_next %}
        <a class="page-link" href="?page={{ page.next_page_number }}&oferta={{ f_oferta|yesno:'1,0' }}&stock={{ f_stock|yesno:'1,0' }}&abierto={{ f_abierto|yesno:'1,0' }}&orden={{ orden }}">Ã‚Â»</a>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
(function(){
  const sel = document.getElementById('ordenSel');
  if (!sel) return;
  sel.addEventListener('change', () => {
    const sp = new URLSearchParams(window.location.search);
    sp.set('orden', sel.value);
    sp.delete('page');
    window.location.search = sp.toString();
  });
})();
</script>
{% endblock %}

