{% extends "base.html" %}
{% block title %}Detalle del Pack{% endblock %}

{% block content %}
  <a href="{% url 'packs:list' %}">← Volver</a>

  <div id="detalle" style="margin-top:1rem;">
    <p>Cargando…</p>
  </div>

  <div id="msg" style="margin-top:1rem; color:green; font-weight:bold;"></div>

  <script>
    // Helper CSRF
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function money(x){
      try { return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(x); }
      catch { return `$${x}` }
    }

    async function cargarDetalle() {
      try {
        const res = await fetch(`/api/packs/{{ pk }}/`);
        if (!res.ok) {
          document.getElementById("detalle").innerHTML = `<p>Error ${res.status}</p>`;
          return;
        }
        const p = await res.json();
        const img = p.imagen_url || `https://picsum.photos/seed/${p.id}/600/300`;
        const partner = p["partner-nombre"] || p.partner_nombre || "-";
        const precio = p.precio_oferta ?? p.precio ?? 0;

        document.getElementById("detalle").innerHTML = `
          <img src="${img}" alt="${p.titulo}" style="max-width:420px;border-radius:12px;display:block;margin-bottom:12px">
          <h1 style="margin:0 0 8px 0">${p.titulo}</h1>
          <p><b>Comercio:</b> ${partner}</p>
          <p><b>Etiqueta:</b> ${p.etiqueta || "-"}</p>
          <p><b>Stock:</b> ${p.stock}</p>
          <p><b>Precio:</b> ${money(precio)}</p>
          <div id="acciones"></div>
        `;

        // Render del botón (según login/stock)
        const acciones = document.getElementById("acciones");

        {% if user.is_authenticated %}
          if (p.stock > 0) {
            acciones.innerHTML = `<button id="reservarBtn">Reservar</button>`;
            document.getElementById("reservarBtn").onclick = async () => {
              const r = await fetch(`/api/packs/${p.id}/reservar/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                credentials: "same-origin",
              });
              const data = await r.json().catch(()=>({detail:"Error"}));
              if (r.ok) {
                document.getElementById("msg").textContent = data.detail || "Reservado ✅";
                acciones.innerHTML = `<span>Reservado ✅</span>`;
              } else {
                if (r.status === 401) {
                  window.location = `/accounts/login/?next=${encodeURIComponent(location.pathname)}`;
                } else {
                  alert(data.detail || "Error al reservar");
                }
              }
            };
          } else {
            acciones.innerHTML = `<span>Sin stock</span>`;
          }
        {% else %}
          acciones.innerHTML = `<a class="btn" href="{% url 'login' %}?next={{ request.path|urlencode }}">Ingresar para reservar</a>`;
        {% endif %}
      } catch (e) {
        console.error(e);
        document.getElementById("detalle").innerHTML = "<p>Error cargando el pack.</p>";
      }
    }

    cargarDetalle();
  </script>
{% endblock %}
