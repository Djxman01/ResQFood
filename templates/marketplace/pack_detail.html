{% extends "base.html" %}
{% load static %}

{% block title %}{{ meta_title }}{% endblock %}

{% block content %}
<style>
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px;}
  .grid{display:grid;gap:16px;grid-template-columns:1fr;}
  @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr;}}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;}
  .pad{padding:12px;}
  .title{margin:0 0 6px;font-size:1.4rem;font-weight:800;color:#f59e0b;}
  .muted{color:#6b7280;}
  .price{font-weight:900;font-size:1.4rem;}
  .price s{color:#9ca3af;font-weight:500;margin-left:6px;}
  .badge{font-size:.85rem;border-radius:999px;padding:4px 8px;border:1px solid #e5e7eb;}
  .b-ok{background:#ecfdf5;border-color:#86efac;}
  .b-warn{background:#fffbeb;border-color:#fde68a;}
  .b-err{background:#fef2f2;border-color:#fecaca;}
  .thumb{aspect-ratio:4/3;object-fit:cover;width:100%;display:block;background:#f3f4f6;}
  .thumb-sm{width:84px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;}
  \.thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}\r\n  .thumb, .thumbs{ display:none !important; }\r\n  .img-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:12px}\r\n  .sq{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;border-radius:10px;border:1px solid #e5e7eb;background:#f3f4f6}\r\n  .cta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px;} .pbtn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
   .pbtn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand);}
  
  .rel-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr);} 
  @media(min-width:900px){.rel-grid{grid-template-columns:repeat(4,1fr);}}
</style>

<div class="wrap" itemscope itemtype="https://schema.org/Product">
  <meta itemprop="name" content="{{ pack.titulo }}">
  <meta itemprop="brand" content="{{ pack.partner.nombre }}">
  <div itemprop="offers" itemscope itemtype="https://schema.org/Offer">
    <meta itemprop="priceCurrency" content="ARS">
    <meta itemprop="price" content="{{ price_show }}">
    <meta itemprop="availability" content="{% if pack.stock > 0 %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}">
  </div>

  <div class="grid">
    <div class="card">
      {% if pack.imagen %}
        <img id="heroImg" class="thumb" src="{{ pack.image_or_stock_url }}" alt="{{ pack.titulo }}" loading="eager" decoding="async" data-placeholder="{% static 'img/placeholder-pack.svg' %}" onerror="this.onerror=null; this.src=this.getAttribute('data-placeholder');">
      {% else %}
        <img id="heroImg" class="thumb" src="{% static 'img/placeholder-pack.svg' %}" alt="" aria-hidden="true" data-placeholder="{% static 'img/placeholder-pack.svg' %}">
      {% endif %}
      <!-- Nueva grilla 2x2 de imágenes -->
      <div class="img-grid">
        {% for g in gallery %}
          <img class="sq" src="{{ g }}" alt="{{ pack.titulo }}" loading="lazy" decoding="async">
        {% endfor %}
      </div>

      <div class="pad thumbs">
        {% if pack.imagen %}
          <img class="thumb-sm" src="{{ pack.image_or_stock_url }}" alt="Vista 1" onclick="swapHero(this.src)" data-placeholder="{% static 'img/placeholder-pack.svg' %}" onerror="this.onerror=null; this.src=this.getAttribute('data-placeholder');">
        {% endif %}
        <img class="thumb-sm" src="{% static 'img/placeholder-pack.svg' %}" alt="Vista 2" onclick="swapHero(this.src)">
        <img class="thumb-sm" src="{% static 'img/placeholder-pack.svg' %}" alt="Vista 3" onclick="swapHero(this.src)">
      </div>
    </div>

    <div class="card pad">
      <h1 class="title" itemprop="name">{{ pack.titulo }}</h1>
      <div class="muted">{{ pack.partner.nombre }}</div>
      <div style="margin-top:6px;">
        {% if pack.precio_oferta and pack.precio_oferta < pack.precio_original %}
          <span class="price">${{ pack.precio_oferta }}</span><s>${{ pack.precio_original }}</s>
          <span class="badge b-ok">Oferta</span>
        {% else %}
          <span class="price">${{ pack.precio_original }}</span>
        {% endif %}
        {% if pack.stock <= 0 %}
          <span class="badge b-err">Sin stock</span>
        {% elif pack.stock < 5 %}
          <span class="badge b-warn">¡Quedan {{ pack.stock }}!</span>
        {% else %}
          <span class="badge">Stock: {{ pack.stock }}</span>
        {% endif %}
      </div>

      <div style="margin-top:10px;">
        <div class="muted">Retiro: {{ pack.pickup_start|date:"d/m H:i" }} – {{ pack.pickup_end|date:"H:i" }}</div>
        <div id="countdown" class="muted"></div>
      </div>

      <div class="cta">
        {% if pending_order %}
          <a class="pbtn" href="/orders/{{ pending_order.id }}/?from=pack">Continuar pago</a>
          {% if last_payment and last_payment.status == "pending" %}
            <span class="muted">Pago pendiente…</span>
          {% endif %}
        {% else %}
          <button id="addBtn" type="button" class="pbtn" {% if pack.stock <= 0 %}disabled title="Sin stock"{% endif %}>Agregar al carrito</button>
        {% endif %}
        <a class="pbtn secondary" href="/c/{{ pack.partner.slug|default:pack.partner.id }}/">Ver comercio</a>
      </div>
    </div>
  </div>

  <div style="margin-top:16px;">
    <h2>También te puede interesar</h2>
    <div class="rel-grid">
      {% for r in related %}
        <a class="card link" href="/packs/{{ r.id }}/">
          {% if r.imagen %}
            <img class="thumb" src="{{ r.image_or_stock_url }}" alt="{{ r.titulo }}" loading="lazy" decoding="async" data-placeholder="{% static 'img/placeholder-pack.svg' %}" onerror="this.onerror=null; this.src=this.getAttribute('data-placeholder');">
          {% else %}
            <img class="thumb" src="{% static 'img/placeholder-pack.svg' %}" alt="" aria-hidden="true">
          {% endif %}
          <div class="pad">
            <p class="title">{{ r.titulo }}</p>
            <div class="muted">
              ${{ r.precio_oferta|default:r.precio_original }}
              {% if r.precio_oferta and r.precio_oferta < r.precio_original %}<s>${{ r.precio_original }}</s>{% endif %}
            </div>
          </div>
        </a>
      {% empty %}
        <div class="muted">Sin más packs de este comercio por ahora.</div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function swapHero(src){ const img = document.getElementById('heroImg'); if(img) img.src = src; }
(function(){
  const el = document.getElementById('countdown');
  if(el){
    const end = new Date("{{ pack.pickup_end|date:'Y-m-d H:i:s' }}".replace(' ','T'));
    function tick(){
      const now = new Date();
      const diff = end – now;
      if(diff <= 0){ el.textContent = 'Ventana de retiro finalizada'; return; }
      const h = Math.floor(diff/3.6e6);
      const m = Math.floor((diff%3.6e6)/6e4);
      el.textContent = 'Termina en ' + h + 'h ' + m + 'm';
      setTimeout(tick, 60000);
    }
    tick();
  }

  const btn = document.getElementById('addBtn');
  function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
  if(btn){
    btn.addEventListener('click', async function(){
      if(btn.disabled) return;
      btn.disabled = true; const old=btn.textContent; btn.textContent='Agregando...';
      try{
        const res = await fetch('/api/cart/add/', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') }, credentials:'same-origin', body: JSON.stringify({ pack_id: {{ pack.id }} }) });
        if(res.ok){ btn.textContent='¡Agregado!'; setTimeout(()=>location.href='/cart/', 500); }
        else { btn.textContent='Error, reintentar'; btn.disabled=false; }
      }catch(e){ btn.textContent='Error, reintentar'; btn.disabled=false; }
    });
  }
  // Fallback aleatorio para imágenes rotas o placeholder
  const STOCK_POOL = [
    "{% static 'img/stock/verduleria/1.jpg' %}",
    "{% static 'img/stock/verduleria/2.jpeg' %}",
    "{% static 'img/stock/cafes/1.jpg' %}",
    "{% static 'img/stock/carniceria/2.jpeg' %}",
    "{% static 'img/stock/helados/2.jpeg' %}",
    "{% static 'img/stock/supermercados/3.jpg' %}"
  ];
  function pick(){ return STOCK_POOL[Math.floor(Math.random()*STOCK_POOL.length)]; }
  document.querySelectorAll('.img-grid img, .rel-grid img').forEach(function(img){
    img.addEventListener('error', function(){ img.src = pick(); }, { once:true });
    try{ if((img.currentSrc||img.src||'').includes('placeholder-pack.svg')) img.src = pick(); }catch(e){}
  });
})();
</script>
{% endblock %}














