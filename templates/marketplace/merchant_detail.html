{% extends "base.html" %}
{% block title %}{{ partner.nombre }}{% endblock %}

{% block content %}
<section class="section">
  <h2>{{ partner.nombre }}</h2>
  {% if partner.short_description %}
    <p style="color:#666;">{{ partner.short_description }}</p>
  {% endif %}
  <div id="cart-msg" class="cart-msg" role="status" aria-live="polite" style="display:none;"></div>
  <style>
    .cart-msg{margin:10px 0 16px;padding:10px 12px;border-radius:12px;border:1px solid #fde68a;background:#fffbeb;color:#92400e;}
    .cart-msg.ok{border-color:#86efac;background:#ecfdf5;color:#065f46;}
    .cart-msg.err{border-color:#fecaca;background:#fef2f2;color:#991b1b;}
    .cart-msg-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}
    .cart-msg-actions button{border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:600;}
  </style>

  {% if packs %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;">
      {% for p in packs %}
      <div style="border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;display:block">
        <a href="/packs/{{ p.id }}/" style="text-decoration:none;color:inherit;display:block">
          <img src="{{ p.image_or_stock_url }}" alt="{{ p.titulo }}" style="width:100%;height:150px;object-fit:cover;display:block" data-placeholder="{% static 'img/placeholder-pack.svg' %}">
          <div style="padding:12px">
            <h3 style="margin:8px 0 4px 0">{{ p.titulo }}</h3>
            <div style="color:#666; font-size:14px; margin-bottom:6px">{{ partner.nombre }}</div>
            <div style="font-weight:800">
              {% if p.precio_original and p.precio_original != p.precio_oferta %}
                <span style="color:#999;text-decoration:line-through;margin-right:6px">${{ p.precio_original }}</span> ${{ p.precio_oferta }}
              {% else %}
                ${{ p.precio_oferta|default:p.precio_original }}
              {% endif %}
            </div>
          </div>
        </a>
        <div style="padding:12px; border-top:1px solid #eee;">
          <button type="button" onclick="addToCart({{ p.id }})">Agregar al carrito</button>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Este comercio no tiene packs activos.</p>
  {% endif %}
</section>


<script>
  // Reemplazo de addToCart para mostrar mensajes en la p\u00e1gina en lugar de pop-ups
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  function showCartMessage(text, type, actions){
    const box = document.getElementById('cart-msg');
    if(!box) return;
    box.style.display = 'block';
    box.className = 'cart-msg' + (type === 'ok' ? ' ok' : type === 'err' ? ' err' : '');
    box.innerHTML = '';
    const span = document.createElement('div');
    span.textContent = text;
    box.appendChild(span);
    if(actions && actions.length){
      const wrap = document.createElement('div');
      wrap.className = 'cart-msg-actions';
      actions.forEach(function(action){
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = action.label;
        b.onclick = action.onClick;
        wrap.appendChild(b);
      });
      box.appendChild(wrap);
    }
  }
  async function clearAndRetry(packId, btn){
    await fetch('/api/cart/clear/', { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, credentials:'same-origin' });
    if(btn){ btn.disabled = false; }
    return addToCart(packId, btn);
  }
  async function addToCart(packId, btn){
    try{
      const res = await fetch('/api/cart/add/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        credentials: 'same-origin',
        body: (function(){ const fd=new FormData(); fd.append('pack_id', packId); return fd; })()
      });
      const data = await res.json().catch(()=>({}));
      if(res.status === 401 || res.status === 403){
        window.location = '{% url "login" %}?next=' + encodeURIComponent(location.pathname + location.search);
        return;
      }
      if(!res.ok){
        const msg = (data && data.detail) ? data.detail : 'No se pudo agregar.';
        if(/mismo comercio/i.test(msg)){
          showCartMessage(msg, 'warn', [{
            label: 'Vaciar carrito e intentar de nuevo',
            onClick: () => clearAndRetry(packId, btn)
          }]);
        }else{
          showCartMessage(msg, 'err');
        }
        return;
      }
      if(data && typeof data.item_count !== 'undefined'){
        if(window.updateCartBadge) updateCartBadge(data.item_count);
      }
      showCartMessage('Agregado al carrito', 'ok');
    }catch(e){ showCartMessage('Error de red', 'err'); }
  }
</script>
{% endblock %}
