{% extends "base.html" %}
{% block title %}{{ partner.nombre }}{% endblock %}

{% block content %}
<section class="section">
  <h2>{{ partner.nombre }}</h2>
  {% if partner.short_description %}
    <p style="color:#666;">{{ partner.short_description }}</p>
  {% endif %}

  {% if packs %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;">
      {% for p in packs %}
      <div style="border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;display:block">
        <a href="/packs/{{ p.id }}/" style="text-decoration:none;color:inherit;display:block">
          <img src="{{ p.image_or_stock_url }}" alt="{{ p.titulo }}" style="width:100%;height:150px;object-fit:cover;display:block" data-placeholder="{% static 'img/placeholder-pack.svg' %}">
          <div style="padding:12px">
            <h3 style="margin:8px 0 4px 0">{{ p.titulo }}</h3>
            <div style="color:#666; font-size:14px; margin-bottom:6px">{{ partner.nombre }}</div>
            <div style="font-weight:800">
              {% if p.precio_original and p.precio_original != p.precio_oferta %}
                <span style="color:#999;text-decoration:line-through;margin-right:6px">${{ p.precio_original }}</span> ${{ p.precio_oferta }}
              {% else %}
                ${{ p.precio_oferta|default:p.precio_original }}
              {% endif %}
            </div>
          </div>
        </a>
        <div style="padding:12px; border-top:1px solid #eee;">
          <button type="button" onclick="addToCart({{ p.id }})">Agregar al carrito</button>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Este comercio no tiene packs activos.</p>
  {% endif %}
</section>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  async function addToCart(packId){
    try{
      const res = await fetch('/api/cart/add/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        credentials: 'same-origin',
        body: (function(){ const fd=new FormData(); fd.append('pack_id', packId); return fd; })()
      });
      const data = await res.json().catch(()=>({}));
      if(res.status === 401 || res.status === 403){
        window.location = '{% url "login" %}?next=' + encodeURIComponent(location.pathname + location.search);
        return;
      }
      if(!res.ok){
        if(data && data.detail){
          if(confirm(data.detail + '\n\nÂ¿Vaciar carrito e intentar de nuevo?')){
            const clr = await fetch('/api/cart/clear/', { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, credentials:'same-origin' });
            if(clr.ok){ return addToCart(packId); }
          }
        }else{
          alert('No se pudo agregar.');
        }
        return;
      }
      if(data && typeof data.item_count !== 'undefined'){
        if(window.updateCartBadge) updateCartBadge(data.item_count);
      }
      alert('Agregado al carrito');
    }catch(e){ alert('Error de red'); }
  }
</script>
{% endblock %}
