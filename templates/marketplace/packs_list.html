{% extends "base.html" %}
{% load static %}
{% block title %}Explorar packs Â· ResQFood{% endblock %}

{% block content %}
<style>
  .section { margin: 16px auto; max-width: 1100px; padding: 0 16px; }
  .section h2 { margin: 0 0 12px; color: #111; }
  .carousel{ position:relative; padding:0 24px; }
  .carousel-track{ display:flex; gap:12px; overflow-x:auto; scroll-snap-type:x mandatory; padding-bottom:6px; scrollbar-width:none; }
  .carousel-track::-webkit-scrollbar{ display:none; }
  .carousel-track > a.card{ min-width:240px; scroll-snap-align:start; text-decoration:none; color:inherit; }
  @media (min-width:768px){ .carousel-track > a.card{ min-width:280px; } }
  .carousel-btn{ position:absolute; top:50%; transform:translateY(-50%); border:1px solid var(--brand); background:#fff; color:var(--brand); width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:2; }
  .carousel-btn.prev{ left:4px; }
  .carousel-btn.next{ right:4px; }
</style>

<h1 style="margin:8px 0 12px 0; color:#f59e0b;">Explorar packs</h1>

<div class="section">
  <h2>Algo nuevo para vos</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-new">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-new">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-new" class="carousel-track"></div>
  </div>
  <div id="row-new-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>Opci&oacute;n saludable</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-healthy">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-healthy">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-healthy" class="carousel-track"></div>
  </div>
  <div id="row-healthy-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>Para darte un gusto</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-treat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-treat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-treat" class="carousel-track"></div>
  </div>
  <div id="row-treat-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>&iquest;Ten&eacute;s ganas de algo dulce?</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-sweet">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-sweet">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-sweet" class="carousel-track"></div>
  </div>
  <div id="row-sweet-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>Ofertas imperdibles</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-deals">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-deals">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-deals" class="carousel-track"></div>
  </div>
  <div id="row-deals-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>&Uacute;ltimas horas</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-last">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-last">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-last" class="carousel-track"></div>
  </div>
  <div id="row-last-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>De panader&iacute;a</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-bakery">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-bakery">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-bakery" class="carousel-track"></div>
  </div>
  <div id="row-bakery-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<div class="section">
  <h2>De carnicer&iacute;a</h2>
  <div class="carousel">
    <button class="carousel-btn prev" type="button" aria-label="Anterior" data-target="#row-butcher">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <button class="carousel-btn next" type="button" aria-label="Siguiente" data-target="#row-butcher">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41L16 12 10 6 8.59 7.41 13.17 12z"/></svg>
    </button>
    <div id="row-butcher" class="carousel-track"></div>
  </div>
  <div id="row-butcher-empty" style="color:#6b7280; display:none;">Sin resultados.</div>
</div>

<script>
  const money = x => { try{ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(x);}catch{ return `$${x}` }};
  const ph = "{% load static %}{% static 'img/placeholder-pack.svg' %}";

  function cardTpl(p){
    const partner = p["partner-nombre"] || p.partner_nombre || "";
    const t = p.titulo || p.nombre || "Pack";
    const pOrig = p.precio_original ?? null;
    const pOfer = p.precio_oferta ?? pOrig ?? 0;
    const img = p.image_url || p.imagen_url || ph;
    return `
      <a class="card" href="/packs/${p.id}/">
        <img class="thumb" src="${img}" alt="${t}" loading="lazy" decoding="async" data-placeholder="${ph}">
        <div class="card-body">
          <p class="title">${t}</p>
          <div class="meta" style="display:flex;justify-content:space-between;color:#6b7280;">
            <span>${money(pOfer)}</span>
            <span>${partner}</span>
          </div>
        </div>
      </a>`;
  }

  async function fetchItems(url){
    const res = await fetch(url);
    if(!res.ok) return [];
    const data = await res.json();
    return Array.isArray(data) ? data : (data.results || []);
  }

  async function loadRowAny(targetId, urls){
    const track = document.getElementById(targetId);
    const empty = document.getElementById(targetId+'-empty');
    let items = [];
    for(const u of urls){
      try{
        items = await fetchItems(u);
        if(items && items.length) break;
      }catch(_e){ /* try next */ }
    }
    if(items && items.length){
      track.innerHTML = items.map(cardTpl).join('');
      if(empty) empty.style.display='none';
    }else{
      if(empty) empty.style.display='block';
    }
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.carousel-btn');
    if(!btn) return;
    const sel = btn.getAttribute('data-target');
    const track = document.querySelector(sel);
    if(!track) return;
    const dir = btn.classList.contains('prev') ? -1 : 1;
    track.scrollBy({ left: dir * track.clientWidth * 0.9, behavior:'smooth' });
  });

  loadRowAny('row-new', [
    '/api/packs/?vigentes=1&ordering=-creado_at',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-healthy', [
    '/api/packs/?vigentes=1&search=verduleria',
    '/api/packs/?vigentes=1&search=verde',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-treat', [
    '/api/packs/?vigentes=1&search=cafe',
    '/api/packs/?vigentes=1&search=panader',
    '/api/packs/?vigentes=1&search=choco',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-sweet', [
    '/api/packs/?vigentes=1&search=helado',
    '/api/packs/?vigentes=1&search=dulce',
    '/api/packs/?vigentes=1&search=postre',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-deals', [
    '/api/packs/?vigentes=1&etiqueta=excedente',
    '/api/packs/?vigentes=1&ordering=-creado_at',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-last', [
    '/api/packs/?vigentes=1&etiqueta=por_vencer',
    '/api/packs/?vigentes=1&ordering=-creado_at',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-bakery', [
    '/api/packs/?vigentes=1&search=panader',
    '/api/packs/?vigentes=1&search=pan',
    '/api/packs/?vigentes=1'
  ]);
  loadRowAny('row-butcher', [
    '/api/packs/?vigentes=1&search=carnicer',
    '/api/packs/?vigentes=1&search=carne',
    '/api/packs/?vigentes=1'
  ]);
</script>
{% endblock %}
