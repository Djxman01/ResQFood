{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Reserva #{{ order.id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .wrap { max-width: 900px; margin: 1.25rem auto; padding: 0 1rem; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; display:grid; grid-template-columns: 1fr 280px; gap:16px; }
    .muted { color:#6b7280; }
    .badge { font-size:.75rem; padding:.25rem .5rem; border-radius:.5rem; display:inline-block; margin-top:.25rem; }
    .b-pend { background:#FEF3C7; color:#92400E; }
    .b-paga { background:#DBEAFE; color:#1E3A8A; }
    .b-ret  { background:#DCFCE7; color:#166534; }
    .b-canc { background:#E5E7EB; color:#374151; }
    .b-exp  { background:#FEE2E2; color:#991B1B; }
    .btn { border:1px solid #e5e7eb; border-radius:8px; padding:.5rem .75rem; background:white; cursor:pointer; }
    img.cover { width:100%; height:180px; object-fit:cover; border-radius:8px; }

    /* New payment card styles */
    .pay-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff; display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; align-items: start; }
    .pay-left { color: #374151; font-size: 0.95rem; }
    .pay-left strong { display: block; margin-bottom: 4px; }
    .pay-right h4 { margin: 0 0 8px; font-size: 1.05rem; }
    .pm-option { display: flex; align-items: start; gap: 8px; margin: 6px 0; }
    .pm-option input { margin-top: 3px; }
    .pm-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .btn-primary { appearance: none; border: 1px solid #2563eb; background: #2563eb; color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s ease; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-primary[disabled] { opacity: 0.6; cursor: not-allowed; }
    .badge-id { color: #6b7280; font-size: 0.9rem; }
    @media (max-width: 600px) { .pay-card { grid-template-columns: 1fr; } }
  </style>
  </head>
<body>
  <main class="wrap">
    <a href="{% if from_cart %}/cart/{% else %}{% url 'mis_reservas' %}{% endif %}" class="btn">← Volver</a>
    <h1 style="font-size:1.5rem; font-weight:700; margin:1rem 0;">Detalle del pedido #{{ order.id }}</h1>

    <section class="card">
      <div>
        {% if order.pack.imagen %}
          <img class="cover" src="{{ order.pack.imagen.url }}" alt="{{ order.pack.titulo }}">
        {% endif %}

        <h2 style="margin:.5rem 0; font-weight:700;">{{ order.pack.titulo }}</h2>
        <div class="muted">{{ order.pack.partner.nombre }}</div>

        <p class="muted" style="margin-top:.5rem;">
          <strong>Retiro:</strong>
          {{ order.pack.pickup_start|date:"d/m/Y H:i" }} – {{ order.pack.pickup_end|date:"d/m/Y H:i" }}
        </p>

        <p class="muted"><strong>Precio:</strong> ${{ order.precio_pagado|floatformat:2 }}</p>

        {% with es=order.estado %}
          <span id="estado-badge" class="badge
            {% if es == 'pendiente' %}b-pend
            {% elif es == 'pagado' %}b-paga
            {% elif es == 'retirado' %}b-ret
            {% elif es == 'cancelado' %}b-canc
            {% elif es == 'expirado' %}b-exp
            {% endif %}
          ">{{ es|upper }}</span>
        {% endwith %}
      </div>

      <div>
        {% if order.estado == 'pagado' %}
          <div style="border:1px dashed #e5e7eb; border-radius:12px; display:flex; align-items:center; justify-content:center; padding:12px;">
            <img src="{% url 'order_qr' order.id %}" alt="QR de la reserva">
          </div>
          <p class="muted" style="text-align:center; margin-top:.5rem;">
            Mostrá este código en el comercio para canjear tu pack.
          </p>
        {% else %}
          <div class="pay-card">
            <div class="pay-left">
              <strong>El QR aparecerá cuando el pago esté confirmado.</strong>
              <div class="muted">Usá Mercado Pago, efectivo o transferencia.</div>
            </div>
            <div class="pay-right">
              <h4>Elegí cómo pagar:</h4>
              <label class="pm-option">
                <input type="radio" name="metodo_pago" value="mp" {% if order.metodo_pago == "mp" %}checked{% endif %}>
                <span>Mercado Pago (tarjeta, efectivo, QR)</span>
              </label>
              <label class="pm-option">
                <input type="radio" name="metodo_pago" value="efectivo" {% if order.metodo_pago == "efectivo" %}checked{% endif %}>
                <span>Efectivo al retirar</span>
              </label>
              <label class="pm-option">
                <input type="radio" name="metodo_pago" value="transferencia" {% if order.metodo_pago == "transferencia" %}checked{% endif %}>
                <span>Transferencia bancaria</span>
              </label>
              <div class="pm-actions">
                {% with price=order.precio_pagado|default:order.pack.precio_oferta|default:order.pack.precio_original|default:0 %}
                <button id="payNowBtn" class="btn-primary" data-order-id="{{ order.id }}" {% if order.estado == 'pagado' or not price %}disabled{% endif %}>Pagar ahora</button>
                {% endwith %}
                <button id="cashConfirmBtn" class="btn-primary" style="display:none;" data-order-id="{{ order.id }}">Confirmar reserva (efectivo)</button>
                <button id="transferStartBtn" class="btn-primary" style="display:none;" data-order-id="{{ order.id }}">Ver datos de transferencia</button>
                <span id="payLoading" class="muted" style="display:none;">Procesando…</span>
                <div id="payError" class="muted" style="display:none;color:#b00020;" aria-live="polite"></div>
                <span class="badge-id">ID de pedido: #{{ order.id }}</span>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </section>
  </main>
</body>
</html>

{% if order.estado != 'pagado' %}
<script>
  (function(){
    const orderId = {{ order.id }};
    let attempts = 0, maxAttempts = 20;
    const badge = document.getElementById('estado-badge');
    const payBtn = document.getElementById('payNowBtn');
    function poll(){
      fetch('/api/payments/status/' + orderId + '/', {credentials:'same-origin'})
        .then(r => r.json())
        .then(data => {
          if(badge) badge.textContent = data.order_estado;
          if(data.order_estado === 'pagado'){
            if(payBtn) payBtn.disabled = true;
            return;
          }
          if(++attempts < maxAttempts) setTimeout(poll, 3000);
        })
        .catch(()=>{ if(++attempts < maxAttempts) setTimeout(poll, 3000); });
    }
    poll();
  })();
</script>
{% endif %}

<script>
(function () {
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const btn = document.getElementById('payNowBtn');
  const spinner = document.getElementById('payLoading');
  const err = document.getElementById('payError');
  const badge = document.getElementById('estado-badge');
  const cashBtn = document.getElementById('cashConfirmBtn');
  const trBtn = document.getElementById('transferStartBtn');

  if (!btn) return;

  // Toggle actions based on selected method
  function showActions(method){
    if(!cashBtn || !trBtn) return;
    cashBtn.style.display = (method === 'efectivo') ? 'inline-block' : 'none';
    trBtn.style.display = (method === 'transferencia') ? 'inline-block' : 'none';
    btn.style.display = (method === 'mp') ? 'inline-block' : 'none';
  }
  document.querySelectorAll('input[name="metodo_pago"]').forEach(r => {
    r.addEventListener('change', async (e) => {
      const method = e.target.value;
      showActions(method);
      try{
        await fetch(`/api/payments/select-method/${btn.getAttribute('data-order-id')}/`, {
          method:'POST', credentials:'same-origin', headers:{'X-CSRFToken': getCookie('csrftoken')},
          body: new URLSearchParams({metodo_pago: method})
        });
      }catch(_){/* ignore */}
    });
  });

  // Initialize visible action
  const checked = document.querySelector('input[name="metodo_pago"]:checked');
  if(checked) showActions(checked.value);

  let inFlight = false;
  async function startPayment(orderId) {
    if (inFlight) return;
    inFlight = true;
    if (err) err.style.display = 'none';
    if (spinner) spinner.style.display = 'inline';
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');
    try {
      const resp = await fetch(`/api/payments/mp/start/${orderId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`No se pudo iniciar el pago (${resp.status}). ${text || ''}`);
      }
      const data = await resp.json();
      if (!data.init_point) throw new Error('No se recibió init_point desde el servidor.');
      window.location.href = data.init_point;
    } catch (e) {
      if (err) { err.textContent = e && e.message ? e.message : 'Error en la red. Intentá nuevamente.'; err.style.display = 'block'; }
      btn.disabled = false;
    } finally {
      if (spinner) spinner.style.display = 'none';
      btn.removeAttribute('aria-busy');
      inFlight = false;
    }
  }
  btn.addEventListener('click', function () {
    const orderId = this.getAttribute('data-order-id');
    if (!orderId) return;
    if (badge && badge.textContent.trim().toLowerCase() === 'pagado') { this.disabled = true; return; }
    startPayment(orderId);
  });

  cashBtn && cashBtn.addEventListener('click', async () => {
    if (spinner) spinner.style.display = 'inline';
    if (err) err.style.display = 'none';
    try {
      const resp = await fetch(`/api/payments/cash/start/${btn.getAttribute('data-order-id')}/`, { method:'POST', credentials:'same-origin', headers:{'X-CSRFToken': getCookie('csrftoken')} });
      if (!resp.ok) throw new Error(await resp.text());
      alert('Reserva confirmada. Pagás en efectivo al retirar.');
    } catch(ex){ if(err){ err.textContent = ex.message || 'No se pudo confirmar la reserva en efectivo.'; err.style.display='block'; } }
    finally { if (spinner) spinner.style.display = 'none'; }
  });

  trBtn && trBtn.addEventListener('click', async () => {
    if (spinner) spinner.style.display = 'inline';
    if (err) err.style.display = 'none';
    try {
      const resp = await fetch(`/api/payments/transfer/start/${btn.getAttribute('data-order-id')}/`, { method:'POST', credentials:'same-origin', headers:{'X-CSRFToken': getCookie('csrftoken')} });
      if (!resp.ok) throw new Error(await resp.text());
      const data = await resp.json();
      const b = data.bank || {};
      alert(`Datos para transferir:\nTitular: ${b.titular}\nCUIT: ${b.cuit}\nAlias: ${b.alias}\nCBU: ${b.cbu}`);
    } catch(ex){ if(err){ err.textContent = ex.message || 'No se pudo iniciar el flujo de transferencia.'; err.style.display='block'; } }
    finally { if (spinner) spinner.style.display = 'none'; }
  });
})();
</script>
