{% extends "base.html" %}
{% block title %}Mi Carrito{% endblock %}

{% block content %}
<style>
  .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
  .muted { color:#6b7280; font-size:.9rem; }
  .thumb { width:100%; height:160px; object-fit:cover; border-radius:8px; display:block; }
  .btn { border:1px solid #e5e7eb; border-radius:8px; padding:.5rem .75rem; background:#fff; cursor:pointer; }
  .btn.primary { border-color:#2563eb; background:#2563eb; color:#fff; }
  .notice { padding:8px 12px; border:1px solid #f59e0b; background:#fffbeb; color:#92400e; border-radius:8px; margin-bottom:12px; }
  .topbar { display:flex; justify-content:flex-start !important; align-items:center; gap:10px; margin-bottom:.75rem; }
  .topbar .btn { padding:.4rem .6rem; }
  .totals { margin-top:1rem; }
  .totals div { margin:2px 0; }
  .wrap { max-width:1100px; margin: 12px auto; padding: 0 16px; text-align:left; }
</style>

<div class="wrap">
  <div class="topbar">
    <button class="btn" type="button" onclick="goBack()">← Volver</button>
    <h1 style="font-size:1.3rem; font-weight:700; margin:0; text-align:left;">Mi Carrito</h1>
  </div>

{% if pending_order_id %}
  <div class="notice">Tenés un pedido pendiente de pago. <a href="/orders/{{ pending_order_id }}/?from=cart">Continuar pago</a></div>
{% endif %}

{% if cart and cart.items.all %}
  <ul class="grid" style="list-style:none; padding:0; margin:0;">
    {% for it in cart.items.all %}
      <li class="card">
        {% if it.pack.imagen %}
          <img class="thumb" src="{{ it.pack.image_or_stock_url }}" alt="{{ it.pack.titulo }}">
        {% endif %}
        <div style="margin-top:.5rem;">
          <div style="font-weight:600;">{{ it.pack.titulo }}</div>
          <div class="muted">{{ it.pack.partner.nombre }}</div>
          <div class="muted"><strong>Precio:</strong> ${{ it.pack.precio_oferta }}</div>
          <div class="muted"><strong>Cantidad:</strong> {{ it.quantity }}</div>
        </div>
        <form method="post" action="/api/cart/remove/" onsubmit="return removePack(event, {{ it.pack.id }})">
          {% csrf_token %}
          <button class="btn" style="margin-top:.5rem;">Quitar</button>
        </form>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="muted">Tu carrito está vacío.</p>
{% endif %}

  <div class="totals">
  <div><strong>Comercio:</strong> {% if cart and cart.merchant %}{{ cart.merchant.nombre }}{% else %}-{% endif %}</div>
  <div><strong>Total:</strong> ${% if cart %}{{ cart.total }}{% else %}0.00{% endif %}</div>
  <button class="btn primary" style="margin-top:.5rem;" id="checkoutBtn" {% if pending_order_id %}disabled{% endif %}>Proceder al pago</button>
  <form style="display:none">{% csrf_token %}</form>
</div>

<script>
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  function goBack(){
    try {
      if (window.history.length > 1) {
        window.history.back();
      } else if (document.referrer) {
        window.location.href = document.referrer;
      } else {
        window.location.href = '/';
      }
    } catch(e){ window.location.href = '/'; }
  }

  async function removePack(ev, packId){
    ev.preventDefault();
    try {
      const res = await fetch('/api/cart/remove/', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        credentials: 'same-origin',
        body: JSON.stringify({ pack_id: packId })
      });
      if(res.ok){ location.reload(); } else { alert('No se pudo quitar el pack'); }
    } catch(e){ alert('Error de red'); }
    return false;
  }

  (function(){
    const btn = document.getElementById('checkoutBtn');
    if(!btn) return;
    btn.addEventListener('click', async function(){
      {% if pending_order_id %}
      window.location = '/orders/{{ pending_order_id }}/?from=cart';
      return;
      {% endif %}
      try{
        const res = await fetch('/api/cart/checkout/', {
          method:'POST',
          headers:{ 'X-CSRFToken': getCookie('csrftoken') },
          credentials:'same-origin'
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          alert((data && data.detail) || 'No se pudo procesar el checkout');
          return;
        }
        if(data && (data.detail_url || data.redirect)){
          window.location = data.detail_url || data.redirect;
        } else {
          window.location = '/mis-reservas/';
        }
      }catch(e){ alert('Error de red'); }
    });
  })();
</script>
{% endblock %}
